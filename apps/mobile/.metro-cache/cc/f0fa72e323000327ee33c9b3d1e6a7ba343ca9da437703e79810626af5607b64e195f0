{"dependencies":[{"name":"@babel/runtime/helpers/asyncToGenerator","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"YisBBiy2Xm9DEVdFebZ2nbgAHBo=","exportNames":["*"],"imports":1}},{"name":"react","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":34,"index":34}}],"key":"RtGiGa+/H7VrI7GDQDLhO1UbpU8=","exportNames":["*"],"imports":1}},{"name":"@tanstack/react-query","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":35},"end":{"line":2,"column":55,"index":90}}],"key":"Pzwu/0TIyhnZOrC9PAkpZx92hFo=","exportNames":["*"],"imports":1}},{"name":"@/lib/supabase","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":91},"end":{"line":3,"column":42,"index":133}}],"key":"KSAjB91cgWz7DQuLWke0G0l9TgA=","exportNames":["*"],"imports":1}},{"name":"@/context/AuthProvider","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":4,"column":0,"index":134},"end":{"line":4,"column":49,"index":183}}],"key":"hnDMt1RwOyVwgo481TGNr6ITBm4=","exportNames":["*"],"imports":1}},{"name":"../../queryKeys","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":5,"column":0,"index":184},"end":{"line":5,"column":43,"index":227}}],"key":"9dB6801Llb9DiWHOk43CNQJdoj8=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  var _s = $RefreshSig$();\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  Object.defineProperty(exports, \"default\", {\n    enumerable: true,\n    get: function () {\n      return _default;\n    }\n  });\n  var _babelRuntimeHelpersAsyncToGenerator = require(_dependencyMap[0], \"@babel/runtime/helpers/asyncToGenerator\");\n  var _asyncToGenerator = _interopDefault(_babelRuntimeHelpersAsyncToGenerator);\n  var _react = require(_dependencyMap[1], \"react\");\n  var _tanstackReactQuery = require(_dependencyMap[2], \"@tanstack/react-query\");\n  var _libSupabase = require(_dependencyMap[3], \"@/lib/supabase\");\n  var _contextAuthProvider = require(_dependencyMap[4], \"@/context/AuthProvider\");\n  var _queryKeys = require(_dependencyMap[5], \"../../queryKeys\");\n  var NEGOTIATION_MESSAGE_TYPES = new Set(['card_offer', 'card_offer_response', 'meetup_proposal', 'meetup_response']);\n  /**\n   * Subscribes to Supabase Realtime for new messages in a conversation.\n   * On INSERT, adds the message to the TanStack Query cache.\n   *\n   * Also invalidates trade context when negotiation-related messages arrive,\n   * and calls an optional onNewMessage callback for read tracking.\n   */\n  var useRealtimeChat = (conversationId, options) => {\n    _s();\n    var queryClient = (0, _tanstackReactQuery.useQueryClient)();\n    var _useAuth = (0, _contextAuthProvider.useAuth)(),\n      user = _useAuth.user;\n    (0, _react.useEffect)(() => {\n      if (!conversationId) return;\n      var channel = _libSupabase.supabase.channel(`messages:${conversationId}`).on('postgres_changes', {\n        event: 'INSERT',\n        schema: 'public',\n        table: 'messages',\n        filter: `conversation_id=eq.${conversationId}`\n      }, /*#__PURE__*/function () {\n        var _ref = (0, _asyncToGenerator.default)(function* (payload) {\n          var newMessage = payload.new;\n\n          // Don't duplicate our own optimistically-added messages\n          if (newMessage.sender_id === user?.id) return;\n\n          // Notify caller (for read tracking)\n          options?.onNewMessage?.(newMessage);\n\n          // Fetch the sender info\n          var _yield$supabase$from$ = yield _libSupabase.supabase.from('users').select('id, display_name, avatar_url').eq('id', newMessage.sender_id).single(),\n            senderData = _yield$supabase$from$.data;\n          var messageWithSender = {\n            ...newMessage,\n            sender: senderData ?? {\n              id: newMessage.sender_id,\n              display_name: 'Unknown',\n              avatar_url: null\n            }\n          };\n          var messagesKey = _queryKeys.chatKeys.messages(conversationId);\n          queryClient.setQueryData(messagesKey, old => {\n            if (!old) {\n              return {\n                pages: [[messageWithSender]],\n                pageParams: [null]\n              };\n            }\n\n            // Prevent duplicates\n            var allIds = old.pages.flatMap(page => page.map(m => m.id));\n            if (allIds.includes(messageWithSender.id)) return old;\n            return {\n              ...old,\n              pages: [[messageWithSender, ...(old.pages[0] ?? [])], ...old.pages.slice(1)]\n            };\n          });\n\n          // Also invalidate conversations list to update last message\n          queryClient.invalidateQueries({\n            queryKey: _queryKeys.chatKeys.conversations()\n          });\n\n          // Invalidate trade context for negotiation-related messages\n          if (NEGOTIATION_MESSAGE_TYPES.has(newMessage.type)) {\n            queryClient.invalidateQueries({\n              queryKey: _queryKeys.chatKeys.tradeContext(conversationId)\n            });\n          }\n        });\n        return function (_x) {\n          return _ref.apply(this, arguments);\n        };\n      }()).subscribe();\n      return () => {\n        _libSupabase.supabase.removeChannel(channel);\n      };\n    }, [conversationId, queryClient, user?.id, options]);\n  };\n  _s(useRealtimeChat, \"TDrJ95GxdHquDBjgVv/lJ4LOc/A=\", false, function () {\n    return [_tanstackReactQuery.useQueryClient, _contextAuthProvider.useAuth];\n  });\n  var _default = useRealtimeChat;\n});","lineCount":110,"map":[[13,2,126,0,"Object"],[13,8,126,0],[13,9,126,0,"defineProperty"],[13,23,126,0],[13,24,126,0,"exports"],[13,31,126,0],[14,4,126,0,"enumerable"],[14,14,126,0],[15,4,126,0,"get"],[15,7,126,0],[15,18,126,0,"get"],[15,19,126,0],[16,6,126,0],[16,13,126,0,"_default"],[16,21,126,0],[17,4,126,0],[18,2,126,0],[19,2,126,31],[19,6,126,31,"_babelRuntimeHelpersAsyncToGenerator"],[19,42,126,31],[19,45,126,31,"require"],[19,52,126,31],[19,53,126,31,"_dependencyMap"],[19,67,126,31],[20,2,126,31],[20,6,126,31,"_asyncToGenerator"],[20,23,126,31],[20,26,126,31,"_interopDefault"],[20,41,126,31],[20,42,126,31,"_babelRuntimeHelpersAsyncToGenerator"],[20,78,126,31],[21,2,1,0],[21,6,1,0,"_react"],[21,12,1,0],[21,15,1,0,"require"],[21,22,1,0],[21,23,1,0,"_dependencyMap"],[21,37,1,0],[22,2,2,0],[22,6,2,0,"_tanstackReactQuery"],[22,25,2,0],[22,28,2,0,"require"],[22,35,2,0],[22,36,2,0,"_dependencyMap"],[22,50,2,0],[23,2,3,0],[23,6,3,0,"_libSupabase"],[23,18,3,0],[23,21,3,0,"require"],[23,28,3,0],[23,29,3,0,"_dependencyMap"],[23,43,3,0],[24,2,4,0],[24,6,4,0,"_contextAuthProvider"],[24,26,4,0],[24,29,4,0,"require"],[24,36,4,0],[24,37,4,0,"_dependencyMap"],[24,51,4,0],[25,2,5,0],[25,6,5,0,"_queryKeys"],[25,16,5,0],[25,19,5,0,"require"],[25,26,5,0],[25,27,5,0,"_dependencyMap"],[25,41,5,0],[26,2,10,0],[26,6,10,6,"NEGOTIATION_MESSAGE_TYPES"],[26,31,10,31],[26,34,10,34],[26,38,10,38,"Set"],[26,41,10,41],[26,42,10,42],[26,43,11,2],[26,55,11,14],[26,57,12,2],[26,78,12,23],[26,80,13,2],[26,97,13,19],[26,99,14,2],[26,116,14,19],[26,117,15,1],[26,118,15,2],[27,2,22,0],[28,0,23,0],[29,0,24,0],[30,0,25,0],[31,0,26,0],[32,0,27,0],[33,0,28,0],[34,2,29,0],[34,6,29,6,"useRealtimeChat"],[34,21,29,21],[34,24,29,24,"useRealtimeChat"],[34,25,30,2,"conversationId"],[34,39,30,24],[34,41,31,2,"options"],[34,48,31,34],[34,53,32,5],[35,4,32,5,"_s"],[35,6,32,5],[36,4,33,2],[36,8,33,8,"queryClient"],[36,19,33,19],[36,22,33,22],[36,26,33,22,"useQueryClient"],[36,45,33,36],[36,46,33,36,"useQueryClient"],[36,60,33,36],[36,62,33,37],[36,63,33,38],[37,4,34,2],[37,8,34,2,"_useAuth"],[37,16,34,2],[37,19,34,19],[37,23,34,19,"useAuth"],[37,43,34,26],[37,44,34,26,"useAuth"],[37,51,34,26],[37,53,34,27],[37,54,34,28],[38,6,34,10,"user"],[38,10,34,14],[38,13,34,14,"_useAuth"],[38,21,34,14],[38,22,34,10,"user"],[38,26,34,14],[39,4,36,2],[39,8,36,2,"useEffect"],[39,14,36,11],[39,15,36,11,"useEffect"],[39,24,36,11],[39,26,36,12],[39,32,36,18],[40,6,37,4],[40,10,37,8],[40,11,37,9,"conversationId"],[40,25,37,23],[40,27,37,25],[41,6,39,4],[41,10,39,10,"channel"],[41,17,39,17],[41,20,39,20,"supabase"],[41,32,39,28],[41,33,39,28,"supabase"],[41,41,39,28],[41,42,40,7,"channel"],[41,49,40,14],[41,50,40,15],[41,62,40,27,"conversationId"],[41,76,40,41],[41,78,40,43],[41,79,40,44],[41,80,41,7,"on"],[41,82,41,9],[41,83,42,8],[41,101,42,26],[41,103,43,8],[42,8,44,10,"event"],[42,13,44,15],[42,15,44,17],[42,23,44,25],[43,8,45,10,"schema"],[43,14,45,16],[43,16,45,18],[43,24,45,26],[44,8,46,10,"table"],[44,13,46,15],[44,15,46,17],[44,25,46,27],[45,8,47,10,"filter"],[45,14,47,16],[45,16,47,18],[45,38,47,40,"conversationId"],[45,52,47,54],[46,6,48,8],[46,7,48,9],[47,8,48,9],[47,12,48,9,"_ref"],[47,16,48,9],[47,23,48,9,"_asyncToGenerator"],[47,40,48,9],[47,41,48,9,"default"],[47,48,48,9],[47,50,49,8],[47,61,49,15,"payload"],[47,68,49,22],[47,70,49,27],[48,10,50,10],[48,14,50,16,"newMessage"],[48,24,50,26],[48,27,50,29,"payload"],[48,34,50,36],[48,35,50,37,"new"],[48,38,50,40],[50,10,52,10],[51,10,53,10],[51,14,53,14,"newMessage"],[51,24,53,24],[51,25,53,25,"sender_id"],[51,34,53,34],[51,39,53,39,"user"],[51,43,53,43],[51,45,53,45,"id"],[51,47,53,47],[51,49,53,49],[53,10,55,10],[54,10,56,10,"options"],[54,17,56,17],[54,19,56,19,"onNewMessage"],[54,31,56,31],[54,34,56,34,"newMessage"],[54,44,56,44],[54,45,56,45],[56,10,58,10],[57,10,59,10],[57,14,59,10,"_yield$supabase$from$"],[57,35,59,10],[57,44,59,45,"supabase"],[57,56,59,53],[57,57,59,53,"supabase"],[57,65,59,53],[57,66,60,13,"from"],[57,70,60,17],[57,71,60,18],[57,78,60,25],[57,79,60,26],[57,80,61,13,"select"],[57,86,61,19],[57,87,61,20],[57,117,61,50],[57,118,61,51],[57,119,62,13,"eq"],[57,121,62,15],[57,122,62,16],[57,126,62,20],[57,128,62,22,"newMessage"],[57,138,62,32],[57,139,62,33,"sender_id"],[57,148,62,42],[57,149,62,43],[57,150,63,13,"single"],[57,156,63,19],[57,157,63,20],[57,158,63,21],[58,12,59,24,"senderData"],[58,22,59,34],[58,25,59,34,"_yield$supabase$from$"],[58,46,59,34],[58,47,59,18,"data"],[58,51,59,22],[59,10,65,10],[59,14,65,16,"messageWithSender"],[59,31,65,52],[59,34,65,55],[60,12,66,12],[60,15,66,15,"newMessage"],[60,25,66,25],[61,12,67,12,"sender"],[61,18,67,18],[61,20,67,21,"senderData"],[61,30,67,31],[61,34,70,18],[62,14,71,14,"id"],[62,16,71,16],[62,18,71,18,"newMessage"],[62,28,71,28],[62,29,71,29,"sender_id"],[62,38,71,38],[63,14,72,14,"display_name"],[63,26,72,26],[63,28,72,28],[63,37,72,37],[64,14,73,14,"avatar_url"],[64,24,73,24],[64,26,73,26],[65,12,74,12],[66,10,75,10],[66,11,75,11],[67,10,77,10],[67,14,77,16,"messagesKey"],[67,25,77,27],[67,28,77,30,"chatKeys"],[67,38,77,38],[67,39,77,38,"chatKeys"],[67,47,77,38],[67,48,77,39,"messages"],[67,56,77,47],[67,57,77,48,"conversationId"],[67,71,77,62],[67,72,77,63],[68,10,79,10,"queryClient"],[68,21,79,21],[68,22,79,22,"setQueryData"],[68,34,79,34],[68,35,80,12,"messagesKey"],[68,46,80,23],[68,48,81,13,"old"],[68,51,81,16],[68,55,81,21],[69,12,82,14],[69,16,82,18],[69,17,82,19,"old"],[69,20,82,22],[69,22,82,24],[70,14,83,16],[70,21,83,23],[71,16,84,18,"pages"],[71,21,84,23],[71,23,84,25],[71,24,84,26],[71,25,84,27,"messageWithSender"],[71,42,84,44],[71,43,84,45],[71,44,84,46],[72,16,85,18,"pageParams"],[72,26,85,28],[72,28,85,30],[72,29,85,31],[72,33,85,35],[73,14,86,16],[73,15,86,17],[74,12,87,14],[76,12,89,14],[77,12,90,14],[77,16,90,20,"allIds"],[77,22,90,26],[77,25,90,29,"old"],[77,28,90,32],[77,29,90,33,"pages"],[77,34,90,38],[77,35,90,39,"flatMap"],[77,42,90,46],[77,43,90,48,"page"],[77,47,90,52],[77,51,91,16,"page"],[77,55,91,20],[77,56,91,21,"map"],[77,59,91,24],[77,60,91,26,"m"],[77,61,91,27],[77,65,91,32,"m"],[77,66,91,33],[77,67,91,34,"id"],[77,69,91,36],[77,70,92,14],[77,71,92,15],[78,12,93,14],[78,16,93,18,"allIds"],[78,22,93,24],[78,23,93,25,"includes"],[78,31,93,33],[78,32,93,34,"messageWithSender"],[78,49,93,51],[78,50,93,52,"id"],[78,52,93,54],[78,53,93,55],[78,55,93,57],[78,62,93,64,"old"],[78,65,93,67],[79,12,95,14],[79,19,95,21],[80,14,96,16],[80,17,96,19,"old"],[80,20,96,22],[81,14,97,16,"pages"],[81,19,97,21],[81,21,97,23],[81,22,98,18],[81,23,98,19,"messageWithSender"],[81,40,98,36],[81,42,98,38],[81,46,98,42,"old"],[81,49,98,45],[81,50,98,46,"pages"],[81,55,98,51],[81,56,98,52],[81,57,98,53],[81,58,98,54],[81,62,98,58],[81,64,98,60],[81,65,98,61],[81,66,98,62],[81,68,99,18],[81,71,99,21,"old"],[81,74,99,24],[81,75,99,25,"pages"],[81,80,99,30],[81,81,99,31,"slice"],[81,86,99,36],[81,87,99,37],[81,88,99,38],[81,89,99,39],[82,12,101,14],[82,13,101,15],[83,10,102,12],[83,11,103,10],[83,12,103,11],[85,10,105,10],[86,10,106,10,"queryClient"],[86,21,106,21],[86,22,106,22,"invalidateQueries"],[86,39,106,39],[86,40,106,40],[87,12,107,12,"queryKey"],[87,20,107,20],[87,22,107,22,"chatKeys"],[87,32,107,30],[87,33,107,30,"chatKeys"],[87,41,107,30],[87,42,107,31,"conversations"],[87,55,107,44],[87,56,107,45],[88,10,108,10],[88,11,108,11],[88,12,108,12],[90,10,110,10],[91,10,111,10],[91,14,111,14,"NEGOTIATION_MESSAGE_TYPES"],[91,39,111,39],[91,40,111,40,"has"],[91,43,111,43],[91,44,111,44,"newMessage"],[91,54,111,54],[91,55,111,55,"type"],[91,59,111,59],[91,60,111,60],[91,62,111,62],[92,12,112,12,"queryClient"],[92,23,112,23],[92,24,112,24,"invalidateQueries"],[92,41,112,41],[92,42,112,42],[93,14,113,14,"queryKey"],[93,22,113,22],[93,24,113,24,"chatKeys"],[93,34,113,32],[93,35,113,32,"chatKeys"],[93,43,113,32],[93,44,113,33,"tradeContext"],[93,56,113,45],[93,57,113,46,"conversationId"],[93,71,113,60],[94,12,114,12],[94,13,114,13],[94,14,114,14],[95,10,115,10],[96,8,116,8],[96,9,116,9],[97,8,116,9],[97,25,116,9,"_x"],[97,27,116,9],[98,10,116,9],[98,17,116,9,"_ref"],[98,21,116,9],[98,22,116,9,"apply"],[98,27,116,9],[98,34,116,9,"arguments"],[98,43,116,9],[99,8,116,9],[100,6,116,9],[100,9,117,6],[100,10,117,7],[100,11,118,7,"subscribe"],[100,20,118,16],[100,21,118,17],[100,22,118,18],[101,6,120,4],[101,13,120,11],[101,19,120,17],[102,8,121,6,"supabase"],[102,20,121,14],[102,21,121,14,"supabase"],[102,29,121,14],[102,30,121,15,"removeChannel"],[102,43,121,28],[102,44,121,29,"channel"],[102,51,121,36],[102,52,121,37],[103,6,122,4],[103,7,122,5],[104,4,123,2],[104,5,123,3],[104,7,123,5],[104,8,123,6,"conversationId"],[104,22,123,20],[104,24,123,22,"queryClient"],[104,35,123,33],[104,37,123,35,"user"],[104,41,123,39],[104,43,123,41,"id"],[104,45,123,43],[104,47,123,45,"options"],[104,54,123,52],[104,55,123,53],[104,56,123,54],[105,2,124,0],[105,3,124,1],[106,2,124,2,"_s"],[106,4,124,2],[106,5,29,6,"useRealtimeChat"],[106,20,29,21],[107,4,29,21],[107,12,33,22,"useQueryClient"],[107,31,33,36],[107,32,33,36,"useQueryClient"],[107,46,33,36],[107,48,34,19,"useAuth"],[107,68,34,26],[107,69,34,26,"useAuth"],[107,76,34,26],[108,2,34,26],[109,2,126,0],[109,6,126,0,"_default"],[109,14,126,0],[109,17,126,15,"useRealtimeChat"],[109,32,126,30],[110,0,126,31],[110,3]],"functionMap":{"names":["<global>","useRealtimeChat","useEffect$argument_0","supabase.channel.on$argument_2","queryClient.setQueryData$argument_1","old.pages.flatMap$argument_0","page.map$argument_0","<anonymous>"],"mappings":"AAA;wBC4B;YCO;QCa;YCgC;+CCS;yBCC,WD,CD;aDW;SDc;WKI;KLE;GDC;CDC"},"hasCjsExports":false},"type":"js/module"}]}