{"dependencies":[{"name":"@babel/runtime/helpers/asyncToGenerator","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"YisBBiy2Xm9DEVdFebZ2nbgAHBo=","exportNames":["*"],"imports":1}},{"name":"@tanstack/react-query","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":68,"index":68}}],"key":"Pzwu/0TIyhnZOrC9PAkpZx92hFo=","exportNames":["*"],"imports":1}},{"name":"@/lib/supabase","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":69},"end":{"line":2,"column":42,"index":111}}],"key":"KSAjB91cgWz7DQuLWke0G0l9TgA=","exportNames":["*"],"imports":1}},{"name":"@/context/AuthProvider","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":112},"end":{"line":3,"column":49,"index":161}}],"key":"hnDMt1RwOyVwgo481TGNr6ITBm4=","exportNames":["*"],"imports":1}},{"name":"../../queryKeys","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":4,"column":0,"index":162},"end":{"line":4,"column":43,"index":205}}],"key":"9dB6801Llb9DiWHOk43CNQJdoj8=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  Object.defineProperty(exports, \"default\", {\n    enumerable: true,\n    get: function () {\n      return _default;\n    }\n  });\n  var _babelRuntimeHelpersAsyncToGenerator = require(_dependencyMap[0]);\n  var _asyncToGenerator = _interopDefault(_babelRuntimeHelpersAsyncToGenerator);\n  var _tanstackReactQuery = require(_dependencyMap[1]);\n  var _libSupabase = require(_dependencyMap[2]);\n  var _contextAuthProvider = require(_dependencyMap[3]);\n  var _queryKeys = require(_dependencyMap[4]);\n  /** Mutation hook that inserts a message with optimistic cache update */\n  var useSendMessage = () => {\n    var _useAuth = (0, _contextAuthProvider.useAuth)(),\n      user = _useAuth.user,\n      profile = _useAuth.profile;\n    var queryClient = (0, _tanstackReactQuery.useQueryClient)();\n    return (0, _tanstackReactQuery.useMutation)({\n      mutationFn: function () {\n        var _ref = (0, _asyncToGenerator.default)(function* (input) {\n          if (!user) throw new Error('Must be signed in to send messages');\n          var _yield$supabase$rpc = yield _libSupabase.supabase.rpc('send_message_v1', {\n              p_conversation_id: input.conversationId,\n              p_sender_id: user.id,\n              p_type: input.type,\n              p_body: input.body ?? null,\n              p_payload: input.payload ? JSON.stringify(input.payload) : null\n            }),\n            rpcResult = _yield$supabase$rpc.data,\n            rpcError = _yield$supabase$rpc.error;\n          if (rpcError) throw rpcError;\n\n          // Re-fetch full message with sender join for cache\n          var row = Array.isArray(rpcResult) ? rpcResult[0] : rpcResult;\n          var _yield$supabase$from$ = yield _libSupabase.supabase.from('messages').select(`\n          *,\n          sender:users!messages_sender_id_fkey (\n            id,\n            display_name,\n            avatar_url\n          )\n        `).eq('id', row.message_id).single(),\n            data = _yield$supabase$from$.data,\n            error = _yield$supabase$from$.error;\n          if (error) throw error;\n          return data;\n        });\n        return function mutationFn(_x) {\n          return _ref.apply(this, arguments);\n        };\n      }(),\n      onMutate: function () {\n        var _ref2 = (0, _asyncToGenerator.default)(function* (input) {\n          if (!user) return;\n          var messagesKey = _queryKeys.chatKeys.messages(input.conversationId);\n\n          // Cancel any outgoing refetches for this conversation\n          yield queryClient.cancelQueries({\n            queryKey: messagesKey\n          });\n\n          // Snapshot the previous value\n          var previousMessages = queryClient.getQueryData(messagesKey);\n\n          // Optimistically add the message to the first page\n          var optimisticMessage = {\n            id: `optimistic-${Date.now()}`,\n            conversation_id: input.conversationId,\n            sender_id: user.id,\n            type: input.type,\n            body: input.body ?? null,\n            payload: input.payload ?? null,\n            created_at: new Date().toISOString(),\n            sender: {\n              id: user.id,\n              display_name: profile?.display_name ?? 'You',\n              avatar_url: profile?.avatar_url ?? null\n            }\n          };\n          queryClient.setQueryData(messagesKey, old => {\n            if (!old) {\n              return {\n                pages: [[optimisticMessage]],\n                pageParams: [null]\n              };\n            }\n            return {\n              ...old,\n              pages: [[optimisticMessage, ...(old.pages[0] ?? [])], ...old.pages.slice(1)]\n            };\n          });\n          return {\n            previousMessages\n          };\n        });\n        return function onMutate(_x2) {\n          return _ref2.apply(this, arguments);\n        };\n      }(),\n      onError: (_err, input, context) => {\n        // Rollback on error\n        if (context?.previousMessages) {\n          queryClient.setQueryData(_queryKeys.chatKeys.messages(input.conversationId), context.previousMessages);\n        }\n      },\n      onSettled: (_data, _error, input) => {\n        // Refetch messages and conversations list\n        queryClient.invalidateQueries({\n          queryKey: _queryKeys.chatKeys.messages(input.conversationId)\n        });\n        queryClient.invalidateQueries({\n          queryKey: _queryKeys.chatKeys.conversations()\n        });\n      }\n    });\n  };\n  var _default = useSendMessage;\n});","lineCount":130,"map":[[12,2,128,0,"Object"],[12,8,128,0],[12,9,128,0,"defineProperty"],[12,23,128,0],[12,24,128,0,"exports"],[12,31,128,0],[13,4,128,0,"enumerable"],[13,14,128,0],[14,4,128,0,"get"],[14,7,128,0],[14,18,128,0,"get"],[14,19,128,0],[15,6,128,0],[15,13,128,0,"_default"],[15,21,128,0],[16,4,128,0],[17,2,128,0],[18,2,128,30],[18,6,128,30,"_babelRuntimeHelpersAsyncToGenerator"],[18,42,128,30],[18,45,128,30,"require"],[18,52,128,30],[18,53,128,30,"_dependencyMap"],[18,67,128,30],[19,2,128,30],[19,6,128,30,"_asyncToGenerator"],[19,23,128,30],[19,26,128,30,"_interopDefault"],[19,41,128,30],[19,42,128,30,"_babelRuntimeHelpersAsyncToGenerator"],[19,78,128,30],[20,2,1,0],[20,6,1,0,"_tanstackReactQuery"],[20,25,1,0],[20,28,1,0,"require"],[20,35,1,0],[20,36,1,0,"_dependencyMap"],[20,50,1,0],[21,2,2,0],[21,6,2,0,"_libSupabase"],[21,18,2,0],[21,21,2,0,"require"],[21,28,2,0],[21,29,2,0,"_dependencyMap"],[21,43,2,0],[22,2,3,0],[22,6,3,0,"_contextAuthProvider"],[22,26,3,0],[22,29,3,0,"require"],[22,36,3,0],[22,37,3,0,"_dependencyMap"],[22,51,3,0],[23,2,4,0],[23,6,4,0,"_queryKeys"],[23,16,4,0],[23,19,4,0,"require"],[23,26,4,0],[23,27,4,0,"_dependencyMap"],[23,41,4,0],[24,2,16,0],[25,2,17,0],[25,6,17,6,"useSendMessage"],[25,20,17,20],[25,23,17,23,"useSendMessage"],[25,24,17,23],[25,29,17,29],[26,4,18,2],[26,8,18,2,"_useAuth"],[26,16,18,2],[26,19,18,28],[26,23,18,28,"useAuth"],[26,43,18,35],[26,44,18,35,"useAuth"],[26,51,18,35],[26,53,18,36],[26,54,18,37],[27,6,18,10,"user"],[27,10,18,14],[27,13,18,14,"_useAuth"],[27,21,18,14],[27,22,18,10,"user"],[27,26,18,14],[28,6,18,16,"profile"],[28,13,18,23],[28,16,18,23,"_useAuth"],[28,24,18,23],[28,25,18,16,"profile"],[28,32,18,23],[29,4,19,2],[29,8,19,8,"queryClient"],[29,19,19,19],[29,22,19,22],[29,26,19,22,"useQueryClient"],[29,45,19,36],[29,46,19,36,"useQueryClient"],[29,60,19,36],[29,62,19,37],[29,63,19,38],[30,4,21,2],[30,11,21,9],[30,15,21,9,"useMutation"],[30,34,21,20],[30,35,21,20,"useMutation"],[30,46,21,20],[30,48,21,21],[31,6,22,4,"mutationFn"],[31,16,22,14],[32,8,22,14],[32,12,22,14,"_ref"],[32,16,22,14],[32,23,22,14,"_asyncToGenerator"],[32,40,22,14],[32,41,22,14,"default"],[32,48,22,14],[32,50,22,16],[32,61,22,23,"input"],[32,66,22,46],[32,68,22,51],[33,10,23,6],[33,14,23,10],[33,15,23,11,"user"],[33,19,23,15],[33,21,23,17],[33,27,23,23],[33,31,23,27,"Error"],[33,36,23,32],[33,37,23,33],[33,73,23,69],[33,74,23,70],[34,10,25,6],[34,14,25,6,"_yield$supabase$rpc"],[34,33,25,6],[34,42,25,57,"supabase"],[34,54,25,65],[34,55,25,65,"supabase"],[34,63,25,65],[34,64,25,66,"rpc"],[34,67,25,69],[34,68,26,8],[34,85,26,25],[34,87,27,8],[35,14,28,10,"p_conversation_id"],[35,31,28,27],[35,33,28,29,"input"],[35,38,28,34],[35,39,28,35,"conversationId"],[35,53,28,49],[36,14,29,10,"p_sender_id"],[36,25,29,21],[36,27,29,23,"user"],[36,31,29,27],[36,32,29,28,"id"],[36,34,29,30],[37,14,30,10,"p_type"],[37,20,30,16],[37,22,30,18,"input"],[37,27,30,23],[37,28,30,24,"type"],[37,32,30,28],[38,14,31,10,"p_body"],[38,20,31,16],[38,22,31,18,"input"],[38,27,31,23],[38,28,31,24,"body"],[38,32,31,28],[38,36,31,32],[38,40,31,36],[39,14,32,10,"p_payload"],[39,23,32,19],[39,25,32,21,"input"],[39,30,32,26],[39,31,32,27,"payload"],[39,38,32,34],[39,41,32,37,"JSON"],[39,45,32,41],[39,46,32,42,"stringify"],[39,55,32,51],[39,56,32,52,"input"],[39,61,32,57],[39,62,32,58,"payload"],[39,69,32,65],[39,70,32,66],[39,73,32,69],[40,12,33,8],[40,13,34,6],[40,14,34,7],[41,12,25,20,"rpcResult"],[41,21,25,29],[41,24,25,29,"_yield$supabase$rpc"],[41,43,25,29],[41,44,25,14,"data"],[41,48,25,18],[42,12,25,38,"rpcError"],[42,20,25,46],[42,23,25,46,"_yield$supabase$rpc"],[42,42,25,46],[42,43,25,31,"error"],[42,48,25,36],[43,10,36,6],[43,14,36,10,"rpcError"],[43,22,36,18],[43,24,36,20],[43,30,36,26,"rpcError"],[43,38,36,34],[45,10,38,6],[46,10,39,6],[46,14,39,12,"row"],[46,17,39,15],[46,20,39,18,"Array"],[46,25,39,23],[46,26,39,24,"isArray"],[46,33,39,31],[46,34,39,32,"rpcResult"],[46,43,39,41],[46,44,39,42],[46,47,39,45,"rpcResult"],[46,56,39,54],[46,57,39,55],[46,58,39,56],[46,59,39,57],[46,62,39,60,"rpcResult"],[46,71,39,69],[47,10,40,6],[47,14,40,6,"_yield$supabase$from$"],[47,35,40,6],[47,44,40,36,"supabase"],[47,56,40,44],[47,57,40,44,"supabase"],[47,65,40,44],[47,66,41,9,"from"],[47,70,41,13],[47,71,41,14],[47,81,41,24],[47,82,41,25],[47,83,42,9,"select"],[47,89,42,15],[47,90,42,16],[48,0,43,0],[49,0,44,0],[50,0,45,0],[51,0,46,0],[52,0,47,0],[53,0,48,0],[54,0,49,0],[54,9,49,9],[54,10,49,10],[54,11,50,9,"eq"],[54,13,50,11],[54,14,50,12],[54,18,50,16],[54,20,50,19,"row"],[54,23,50,22],[54,24,50,50,"message_id"],[54,34,50,60],[54,35,50,61],[54,36,51,9,"single"],[54,42,51,15],[54,43,51,16],[54,44,51,17],[55,12,40,14,"data"],[55,16,40,18],[55,19,40,18,"_yield$supabase$from$"],[55,40,40,18],[55,41,40,14,"data"],[55,45,40,18],[56,12,40,20,"error"],[56,17,40,25],[56,20,40,25,"_yield$supabase$from$"],[56,41,40,25],[56,42,40,20,"error"],[56,47,40,25],[57,10,53,6],[57,14,53,10,"error"],[57,19,53,15],[57,21,53,17],[57,27,53,23,"error"],[57,32,53,28],[58,10,54,6],[58,17,54,13,"data"],[58,21,54,17],[59,8,55,4],[59,9,55,5],[60,8,55,5],[60,24,22,4,"mutationFn"],[60,34,22,14,"mutationFn"],[60,35,22,14,"_x"],[60,37,22,14],[61,10,22,14],[61,17,22,14,"_ref"],[61,21,22,14],[61,22,22,14,"apply"],[61,27,22,14],[61,34,22,14,"arguments"],[61,43,22,14],[62,8,22,14],[63,6,22,14],[63,9,55,5],[64,6,56,4,"onMutate"],[64,14,56,12],[65,8,56,12],[65,12,56,12,"_ref2"],[65,17,56,12],[65,24,56,12,"_asyncToGenerator"],[65,41,56,12],[65,42,56,12,"default"],[65,49,56,12],[65,51,56,14],[65,62,56,21,"input"],[65,67,56,26],[65,69,56,31],[66,10,57,6],[66,14,57,10],[66,15,57,11,"user"],[66,19,57,15],[66,21,57,17],[67,10,59,6],[67,14,59,12,"messagesKey"],[67,25,59,23],[67,28,59,26,"chatKeys"],[67,38,59,34],[67,39,59,34,"chatKeys"],[67,47,59,34],[67,48,59,35,"messages"],[67,56,59,43],[67,57,59,44,"input"],[67,62,59,49],[67,63,59,50,"conversationId"],[67,77,59,64],[67,78,59,65],[69,10,61,6],[70,10,62,6],[70,16,62,12,"queryClient"],[70,27,62,23],[70,28,62,24,"cancelQueries"],[70,41,62,37],[70,42,62,38],[71,12,62,40,"queryKey"],[71,20,62,48],[71,22,62,50,"messagesKey"],[72,10,62,62],[72,11,62,63],[72,12,62,64],[74,10,64,6],[75,10,65,6],[75,14,65,12,"previousMessages"],[75,30,65,28],[75,33,66,8,"queryClient"],[75,44,66,19],[75,45,66,20,"getQueryData"],[75,57,66,32],[75,58,67,10,"messagesKey"],[75,69,68,8],[75,70,68,9],[77,10,70,6],[78,10,71,6],[78,14,71,12,"optimisticMessage"],[78,31,71,48],[78,34,71,51],[79,12,72,8,"id"],[79,14,72,10],[79,16,72,12],[79,30,72,26,"Date"],[79,34,72,30],[79,35,72,31,"now"],[79,38,72,34],[79,39,72,35],[79,40,72,36],[79,42,72,38],[80,12,73,8,"conversation_id"],[80,27,73,23],[80,29,73,25,"input"],[80,34,73,30],[80,35,73,31,"conversationId"],[80,49,73,45],[81,12,74,8,"sender_id"],[81,21,74,17],[81,23,74,19,"user"],[81,27,74,23],[81,28,74,24,"id"],[81,30,74,26],[82,12,75,8,"type"],[82,16,75,12],[82,18,75,14,"input"],[82,23,75,19],[82,24,75,20,"type"],[82,28,75,24],[83,12,76,8,"body"],[83,16,76,12],[83,18,76,14,"input"],[83,23,76,19],[83,24,76,20,"body"],[83,28,76,24],[83,32,76,28],[83,36,76,32],[84,12,77,8,"payload"],[84,19,77,15],[84,21,77,17,"input"],[84,26,77,22],[84,27,77,23,"payload"],[84,34,77,30],[84,38,77,34],[84,42,77,38],[85,12,78,8,"created_at"],[85,22,78,18],[85,24,78,20],[85,28,78,24,"Date"],[85,32,78,28],[85,33,78,29],[85,34,78,30],[85,35,78,31,"toISOString"],[85,46,78,42],[85,47,78,43],[85,48,78,44],[86,12,79,8,"sender"],[86,18,79,14],[86,20,79,16],[87,14,80,10,"id"],[87,16,80,12],[87,18,80,14,"user"],[87,22,80,18],[87,23,80,19,"id"],[87,25,80,21],[88,14,81,10,"display_name"],[88,26,81,22],[88,28,81,24,"profile"],[88,35,81,31],[88,37,81,33,"display_name"],[88,49,81,45],[88,53,81,49],[88,58,81,54],[89,14,82,10,"avatar_url"],[89,24,82,20],[89,26,82,22,"profile"],[89,33,82,29],[89,35,82,31,"avatar_url"],[89,45,82,41],[89,49,82,45],[90,12,83,8],[91,10,84,6],[91,11,84,7],[92,10,86,6,"queryClient"],[92,21,86,17],[92,22,86,18,"setQueryData"],[92,34,86,30],[92,35,87,8,"messagesKey"],[92,46,87,19],[92,48,88,9,"old"],[92,51,88,12],[92,55,88,17],[93,12,89,10],[93,16,89,14],[93,17,89,15,"old"],[93,20,89,18],[93,22,89,20],[94,14,90,12],[94,21,90,19],[95,16,91,14,"pages"],[95,21,91,19],[95,23,91,21],[95,24,91,22],[95,25,91,23,"optimisticMessage"],[95,42,91,40],[95,43,91,41],[95,44,91,42],[96,16,92,14,"pageParams"],[96,26,92,24],[96,28,92,26],[96,29,92,27],[96,33,92,31],[97,14,93,12],[97,15,93,13],[98,12,94,10],[99,12,95,10],[99,19,95,17],[100,14,96,12],[100,17,96,15,"old"],[100,20,96,18],[101,14,97,12,"pages"],[101,19,97,17],[101,21,97,19],[101,22,98,14],[101,23,98,15,"optimisticMessage"],[101,40,98,32],[101,42,98,34],[101,46,98,38,"old"],[101,49,98,41],[101,50,98,42,"pages"],[101,55,98,47],[101,56,98,48],[101,57,98,49],[101,58,98,50],[101,62,98,54],[101,64,98,56],[101,65,98,57],[101,66,98,58],[101,68,99,14],[101,71,99,17,"old"],[101,74,99,20],[101,75,99,21,"pages"],[101,80,99,26],[101,81,99,27,"slice"],[101,86,99,32],[101,87,99,33],[101,88,99,34],[101,89,99,35],[102,12,101,10],[102,13,101,11],[103,10,102,8],[103,11,103,6],[103,12,103,7],[104,10,105,6],[104,17,105,13],[105,12,105,15,"previousMessages"],[106,10,105,32],[106,11,105,33],[107,8,106,4],[107,9,106,5],[108,8,106,5],[108,24,56,4,"onMutate"],[108,32,56,12,"onMutate"],[108,33,56,12,"_x2"],[108,36,56,12],[109,10,56,12],[109,17,56,12,"_ref2"],[109,22,56,12],[109,23,56,12,"apply"],[109,28,56,12],[109,35,56,12,"arguments"],[109,44,56,12],[110,8,56,12],[111,6,56,12],[111,9,106,5],[112,6,107,4,"onError"],[112,13,107,11],[112,15,107,13,"onError"],[112,16,107,14,"_err"],[112,20,107,18],[112,22,107,20,"input"],[112,27,107,25],[112,29,107,27,"context"],[112,36,107,34],[112,41,107,39],[113,8,108,6],[114,8,109,6],[114,12,109,10,"context"],[114,19,109,17],[114,21,109,19,"previousMessages"],[114,37,109,35],[114,39,109,37],[115,10,110,8,"queryClient"],[115,21,110,19],[115,22,110,20,"setQueryData"],[115,34,110,32],[115,35,111,10,"chatKeys"],[115,45,111,18],[115,46,111,18,"chatKeys"],[115,54,111,18],[115,55,111,19,"messages"],[115,63,111,27],[115,64,111,28,"input"],[115,69,111,33],[115,70,111,34,"conversationId"],[115,84,111,48],[115,85,111,49],[115,87,112,10,"context"],[115,94,112,17],[115,95,112,18,"previousMessages"],[115,111,113,8],[115,112,113,9],[116,8,114,6],[117,6,115,4],[117,7,115,5],[118,6,116,4,"onSettled"],[118,15,116,13],[118,17,116,15,"onSettled"],[118,18,116,16,"_data"],[118,23,116,21],[118,25,116,23,"_error"],[118,31,116,29],[118,33,116,31,"input"],[118,38,116,36],[118,43,116,41],[119,8,117,6],[120,8,118,6,"queryClient"],[120,19,118,17],[120,20,118,18,"invalidateQueries"],[120,37,118,35],[120,38,118,36],[121,10,119,8,"queryKey"],[121,18,119,16],[121,20,119,18,"chatKeys"],[121,30,119,26],[121,31,119,26,"chatKeys"],[121,39,119,26],[121,40,119,27,"messages"],[121,48,119,35],[121,49,119,36,"input"],[121,54,119,41],[121,55,119,42,"conversationId"],[121,69,119,56],[122,8,120,6],[122,9,120,7],[122,10,120,8],[123,8,121,6,"queryClient"],[123,19,121,17],[123,20,121,18,"invalidateQueries"],[123,37,121,35],[123,38,121,36],[124,10,122,8,"queryKey"],[124,18,122,16],[124,20,122,18,"chatKeys"],[124,30,122,26],[124,31,122,26,"chatKeys"],[124,39,122,26],[124,40,122,27,"conversations"],[124,53,122,40],[124,54,122,41],[125,8,123,6],[125,9,123,7],[125,10,123,8],[126,6,124,4],[127,4,125,2],[127,5,125,3],[127,6,125,4],[128,2,126,0],[128,3,126,1],[129,2,128,0],[129,6,128,0,"_default"],[129,14,128,0],[129,17,128,15,"useSendMessage"],[129,31,128,29],[130,0,128,30],[130,3]],"functionMap":{"names":["<global>","useSendMessage","useMutation$argument_0.mutationFn","useMutation$argument_0.onMutate","queryClient.setQueryData$argument_1","useMutation$argument_0.onError","useMutation$argument_0.onSettled"],"mappings":"AAA;uBCgB;gBCK;KDiC;cEC;QCgC;SDc;KFI;aIC;KJQ;eKC;KLQ;CDE"},"hasCjsExports":false},"type":"js/module"}]}