{"dependencies":[{"name":"@babel/runtime/helpers/asyncToGenerator","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"YisBBiy2Xm9DEVdFebZ2nbgAHBo=","exportNames":["*"],"imports":1}},{"name":"react","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":34,"index":34}}],"key":"RtGiGa+/H7VrI7GDQDLhO1UbpU8=","exportNames":["*"],"imports":1}},{"name":"@tanstack/react-query","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":35},"end":{"line":2,"column":55,"index":90}}],"key":"Pzwu/0TIyhnZOrC9PAkpZx92hFo=","exportNames":["*"],"imports":1}},{"name":"@/lib/supabase","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":91},"end":{"line":3,"column":42,"index":133}}],"key":"KSAjB91cgWz7DQuLWke0G0l9TgA=","exportNames":["*"],"imports":1}},{"name":"@/context/AuthProvider","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":4,"column":0,"index":134},"end":{"line":4,"column":49,"index":183}}],"key":"hnDMt1RwOyVwgo481TGNr6ITBm4=","exportNames":["*"],"imports":1}},{"name":"../../queryKeys","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":5,"column":0,"index":184},"end":{"line":5,"column":43,"index":227}}],"key":"9dB6801Llb9DiWHOk43CNQJdoj8=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  Object.defineProperty(exports, \"default\", {\n    enumerable: true,\n    get: function () {\n      return _default;\n    }\n  });\n  var _babelRuntimeHelpersAsyncToGenerator = require(_dependencyMap[0]);\n  var _asyncToGenerator = _interopDefault(_babelRuntimeHelpersAsyncToGenerator);\n  var _react = require(_dependencyMap[1]);\n  var _tanstackReactQuery = require(_dependencyMap[2]);\n  var _libSupabase = require(_dependencyMap[3]);\n  var _contextAuthProvider = require(_dependencyMap[4]);\n  var _queryKeys = require(_dependencyMap[5]);\n  var NEGOTIATION_MESSAGE_TYPES = new Set(['card_offer', 'card_offer_response', 'meetup_proposal', 'meetup_response']);\n  /**\n   * Subscribes to Supabase Realtime for new messages in a conversation.\n   * On INSERT, adds the message to the TanStack Query cache.\n   *\n   * Also invalidates trade context when negotiation-related messages arrive,\n   * and calls an optional onNewMessage callback for read tracking.\n   */\n  var useRealtimeChat = (conversationId, options) => {\n    var queryClient = (0, _tanstackReactQuery.useQueryClient)();\n    var _useAuth = (0, _contextAuthProvider.useAuth)(),\n      user = _useAuth.user;\n    (0, _react.useEffect)(() => {\n      if (!conversationId) return;\n      var channel = _libSupabase.supabase.channel(`messages:${conversationId}`).on('postgres_changes', {\n        event: 'INSERT',\n        schema: 'public',\n        table: 'messages',\n        filter: `conversation_id=eq.${conversationId}`\n      }, /*#__PURE__*/function () {\n        var _ref = (0, _asyncToGenerator.default)(function* (payload) {\n          var newMessage = payload.new;\n\n          // Don't duplicate our own optimistically-added messages\n          if (newMessage.sender_id === user?.id) return;\n\n          // Notify caller (for read tracking)\n          options?.onNewMessage?.(newMessage);\n\n          // Fetch the sender info\n          var _yield$supabase$from$ = yield _libSupabase.supabase.from('users').select('id, display_name, avatar_url').eq('id', newMessage.sender_id).single(),\n            senderData = _yield$supabase$from$.data;\n          var messageWithSender = {\n            ...newMessage,\n            sender: senderData ?? {\n              id: newMessage.sender_id,\n              display_name: 'Unknown',\n              avatar_url: null\n            }\n          };\n          var messagesKey = _queryKeys.chatKeys.messages(conversationId);\n          queryClient.setQueryData(messagesKey, old => {\n            if (!old) {\n              return {\n                pages: [[messageWithSender]],\n                pageParams: [null]\n              };\n            }\n\n            // Prevent duplicates\n            var allIds = old.pages.flatMap(page => page.map(m => m.id));\n            if (allIds.includes(messageWithSender.id)) return old;\n            return {\n              ...old,\n              pages: [[messageWithSender, ...(old.pages[0] ?? [])], ...old.pages.slice(1)]\n            };\n          });\n\n          // Also invalidate conversations list to update last message\n          queryClient.invalidateQueries({\n            queryKey: _queryKeys.chatKeys.conversations()\n          });\n\n          // Invalidate trade context for negotiation-related messages\n          if (NEGOTIATION_MESSAGE_TYPES.has(newMessage.type)) {\n            queryClient.invalidateQueries({\n              queryKey: _queryKeys.chatKeys.tradeContext(conversationId)\n            });\n          }\n        });\n        return function (_x) {\n          return _ref.apply(this, arguments);\n        };\n      }()).subscribe();\n      return () => {\n        _libSupabase.supabase.removeChannel(channel);\n      };\n    }, [conversationId, queryClient, user?.id, options]);\n  };\n  var _default = useRealtimeChat;\n});","lineCount":105,"map":[[12,2,126,0,"Object"],[12,8,126,0],[12,9,126,0,"defineProperty"],[12,23,126,0],[12,24,126,0,"exports"],[12,31,126,0],[13,4,126,0,"enumerable"],[13,14,126,0],[14,4,126,0,"get"],[14,7,126,0],[14,18,126,0,"get"],[14,19,126,0],[15,6,126,0],[15,13,126,0,"_default"],[15,21,126,0],[16,4,126,0],[17,2,126,0],[18,2,126,31],[18,6,126,31,"_babelRuntimeHelpersAsyncToGenerator"],[18,42,126,31],[18,45,126,31,"require"],[18,52,126,31],[18,53,126,31,"_dependencyMap"],[18,67,126,31],[19,2,126,31],[19,6,126,31,"_asyncToGenerator"],[19,23,126,31],[19,26,126,31,"_interopDefault"],[19,41,126,31],[19,42,126,31,"_babelRuntimeHelpersAsyncToGenerator"],[19,78,126,31],[20,2,1,0],[20,6,1,0,"_react"],[20,12,1,0],[20,15,1,0,"require"],[20,22,1,0],[20,23,1,0,"_dependencyMap"],[20,37,1,0],[21,2,2,0],[21,6,2,0,"_tanstackReactQuery"],[21,25,2,0],[21,28,2,0,"require"],[21,35,2,0],[21,36,2,0,"_dependencyMap"],[21,50,2,0],[22,2,3,0],[22,6,3,0,"_libSupabase"],[22,18,3,0],[22,21,3,0,"require"],[22,28,3,0],[22,29,3,0,"_dependencyMap"],[22,43,3,0],[23,2,4,0],[23,6,4,0,"_contextAuthProvider"],[23,26,4,0],[23,29,4,0,"require"],[23,36,4,0],[23,37,4,0,"_dependencyMap"],[23,51,4,0],[24,2,5,0],[24,6,5,0,"_queryKeys"],[24,16,5,0],[24,19,5,0,"require"],[24,26,5,0],[24,27,5,0,"_dependencyMap"],[24,41,5,0],[25,2,10,0],[25,6,10,6,"NEGOTIATION_MESSAGE_TYPES"],[25,31,10,31],[25,34,10,34],[25,38,10,38,"Set"],[25,41,10,41],[25,42,10,42],[25,43,11,2],[25,55,11,14],[25,57,12,2],[25,78,12,23],[25,80,13,2],[25,97,13,19],[25,99,14,2],[25,116,14,19],[25,117,15,1],[25,118,15,2],[26,2,22,0],[27,0,23,0],[28,0,24,0],[29,0,25,0],[30,0,26,0],[31,0,27,0],[32,0,28,0],[33,2,29,0],[33,6,29,6,"useRealtimeChat"],[33,21,29,21],[33,24,29,24,"useRealtimeChat"],[33,25,30,2,"conversationId"],[33,39,30,24],[33,41,31,2,"options"],[33,48,31,34],[33,53,32,5],[34,4,33,2],[34,8,33,8,"queryClient"],[34,19,33,19],[34,22,33,22],[34,26,33,22,"useQueryClient"],[34,45,33,36],[34,46,33,36,"useQueryClient"],[34,60,33,36],[34,62,33,37],[34,63,33,38],[35,4,34,2],[35,8,34,2,"_useAuth"],[35,16,34,2],[35,19,34,19],[35,23,34,19,"useAuth"],[35,43,34,26],[35,44,34,26,"useAuth"],[35,51,34,26],[35,53,34,27],[35,54,34,28],[36,6,34,10,"user"],[36,10,34,14],[36,13,34,14,"_useAuth"],[36,21,34,14],[36,22,34,10,"user"],[36,26,34,14],[37,4,36,2],[37,8,36,2,"useEffect"],[37,14,36,11],[37,15,36,11,"useEffect"],[37,24,36,11],[37,26,36,12],[37,32,36,18],[38,6,37,4],[38,10,37,8],[38,11,37,9,"conversationId"],[38,25,37,23],[38,27,37,25],[39,6,39,4],[39,10,39,10,"channel"],[39,17,39,17],[39,20,39,20,"supabase"],[39,32,39,28],[39,33,39,28,"supabase"],[39,41,39,28],[39,42,40,7,"channel"],[39,49,40,14],[39,50,40,15],[39,62,40,27,"conversationId"],[39,76,40,41],[39,78,40,43],[39,79,40,44],[39,80,41,7,"on"],[39,82,41,9],[39,83,42,8],[39,101,42,26],[39,103,43,8],[40,8,44,10,"event"],[40,13,44,15],[40,15,44,17],[40,23,44,25],[41,8,45,10,"schema"],[41,14,45,16],[41,16,45,18],[41,24,45,26],[42,8,46,10,"table"],[42,13,46,15],[42,15,46,17],[42,25,46,27],[43,8,47,10,"filter"],[43,14,47,16],[43,16,47,18],[43,38,47,40,"conversationId"],[43,52,47,54],[44,6,48,8],[44,7,48,9],[45,8,48,9],[45,12,48,9,"_ref"],[45,16,48,9],[45,23,48,9,"_asyncToGenerator"],[45,40,48,9],[45,41,48,9,"default"],[45,48,48,9],[45,50,49,8],[45,61,49,15,"payload"],[45,68,49,22],[45,70,49,27],[46,10,50,10],[46,14,50,16,"newMessage"],[46,24,50,26],[46,27,50,29,"payload"],[46,34,50,36],[46,35,50,37,"new"],[46,38,50,40],[48,10,52,10],[49,10,53,10],[49,14,53,14,"newMessage"],[49,24,53,24],[49,25,53,25,"sender_id"],[49,34,53,34],[49,39,53,39,"user"],[49,43,53,43],[49,45,53,45,"id"],[49,47,53,47],[49,49,53,49],[51,10,55,10],[52,10,56,10,"options"],[52,17,56,17],[52,19,56,19,"onNewMessage"],[52,31,56,31],[52,34,56,34,"newMessage"],[52,44,56,44],[52,45,56,45],[54,10,58,10],[55,10,59,10],[55,14,59,10,"_yield$supabase$from$"],[55,35,59,10],[55,44,59,45,"supabase"],[55,56,59,53],[55,57,59,53,"supabase"],[55,65,59,53],[55,66,60,13,"from"],[55,70,60,17],[55,71,60,18],[55,78,60,25],[55,79,60,26],[55,80,61,13,"select"],[55,86,61,19],[55,87,61,20],[55,117,61,50],[55,118,61,51],[55,119,62,13,"eq"],[55,121,62,15],[55,122,62,16],[55,126,62,20],[55,128,62,22,"newMessage"],[55,138,62,32],[55,139,62,33,"sender_id"],[55,148,62,42],[55,149,62,43],[55,150,63,13,"single"],[55,156,63,19],[55,157,63,20],[55,158,63,21],[56,12,59,24,"senderData"],[56,22,59,34],[56,25,59,34,"_yield$supabase$from$"],[56,46,59,34],[56,47,59,18,"data"],[56,51,59,22],[57,10,65,10],[57,14,65,16,"messageWithSender"],[57,31,65,52],[57,34,65,55],[58,12,66,12],[58,15,66,15,"newMessage"],[58,25,66,25],[59,12,67,12,"sender"],[59,18,67,18],[59,20,67,21,"senderData"],[59,30,67,31],[59,34,70,18],[60,14,71,14,"id"],[60,16,71,16],[60,18,71,18,"newMessage"],[60,28,71,28],[60,29,71,29,"sender_id"],[60,38,71,38],[61,14,72,14,"display_name"],[61,26,72,26],[61,28,72,28],[61,37,72,37],[62,14,73,14,"avatar_url"],[62,24,73,24],[62,26,73,26],[63,12,74,12],[64,10,75,10],[64,11,75,11],[65,10,77,10],[65,14,77,16,"messagesKey"],[65,25,77,27],[65,28,77,30,"chatKeys"],[65,38,77,38],[65,39,77,38,"chatKeys"],[65,47,77,38],[65,48,77,39,"messages"],[65,56,77,47],[65,57,77,48,"conversationId"],[65,71,77,62],[65,72,77,63],[66,10,79,10,"queryClient"],[66,21,79,21],[66,22,79,22,"setQueryData"],[66,34,79,34],[66,35,80,12,"messagesKey"],[66,46,80,23],[66,48,81,13,"old"],[66,51,81,16],[66,55,81,21],[67,12,82,14],[67,16,82,18],[67,17,82,19,"old"],[67,20,82,22],[67,22,82,24],[68,14,83,16],[68,21,83,23],[69,16,84,18,"pages"],[69,21,84,23],[69,23,84,25],[69,24,84,26],[69,25,84,27,"messageWithSender"],[69,42,84,44],[69,43,84,45],[69,44,84,46],[70,16,85,18,"pageParams"],[70,26,85,28],[70,28,85,30],[70,29,85,31],[70,33,85,35],[71,14,86,16],[71,15,86,17],[72,12,87,14],[74,12,89,14],[75,12,90,14],[75,16,90,20,"allIds"],[75,22,90,26],[75,25,90,29,"old"],[75,28,90,32],[75,29,90,33,"pages"],[75,34,90,38],[75,35,90,39,"flatMap"],[75,42,90,46],[75,43,90,48,"page"],[75,47,90,52],[75,51,91,16,"page"],[75,55,91,20],[75,56,91,21,"map"],[75,59,91,24],[75,60,91,26,"m"],[75,61,91,27],[75,65,91,32,"m"],[75,66,91,33],[75,67,91,34,"id"],[75,69,91,36],[75,70,92,14],[75,71,92,15],[76,12,93,14],[76,16,93,18,"allIds"],[76,22,93,24],[76,23,93,25,"includes"],[76,31,93,33],[76,32,93,34,"messageWithSender"],[76,49,93,51],[76,50,93,52,"id"],[76,52,93,54],[76,53,93,55],[76,55,93,57],[76,62,93,64,"old"],[76,65,93,67],[77,12,95,14],[77,19,95,21],[78,14,96,16],[78,17,96,19,"old"],[78,20,96,22],[79,14,97,16,"pages"],[79,19,97,21],[79,21,97,23],[79,22,98,18],[79,23,98,19,"messageWithSender"],[79,40,98,36],[79,42,98,38],[79,46,98,42,"old"],[79,49,98,45],[79,50,98,46,"pages"],[79,55,98,51],[79,56,98,52],[79,57,98,53],[79,58,98,54],[79,62,98,58],[79,64,98,60],[79,65,98,61],[79,66,98,62],[79,68,99,18],[79,71,99,21,"old"],[79,74,99,24],[79,75,99,25,"pages"],[79,80,99,30],[79,81,99,31,"slice"],[79,86,99,36],[79,87,99,37],[79,88,99,38],[79,89,99,39],[80,12,101,14],[80,13,101,15],[81,10,102,12],[81,11,103,10],[81,12,103,11],[83,10,105,10],[84,10,106,10,"queryClient"],[84,21,106,21],[84,22,106,22,"invalidateQueries"],[84,39,106,39],[84,40,106,40],[85,12,107,12,"queryKey"],[85,20,107,20],[85,22,107,22,"chatKeys"],[85,32,107,30],[85,33,107,30,"chatKeys"],[85,41,107,30],[85,42,107,31,"conversations"],[85,55,107,44],[85,56,107,45],[86,10,108,10],[86,11,108,11],[86,12,108,12],[88,10,110,10],[89,10,111,10],[89,14,111,14,"NEGOTIATION_MESSAGE_TYPES"],[89,39,111,39],[89,40,111,40,"has"],[89,43,111,43],[89,44,111,44,"newMessage"],[89,54,111,54],[89,55,111,55,"type"],[89,59,111,59],[89,60,111,60],[89,62,111,62],[90,12,112,12,"queryClient"],[90,23,112,23],[90,24,112,24,"invalidateQueries"],[90,41,112,41],[90,42,112,42],[91,14,113,14,"queryKey"],[91,22,113,22],[91,24,113,24,"chatKeys"],[91,34,113,32],[91,35,113,32,"chatKeys"],[91,43,113,32],[91,44,113,33,"tradeContext"],[91,56,113,45],[91,57,113,46,"conversationId"],[91,71,113,60],[92,12,114,12],[92,13,114,13],[92,14,114,14],[93,10,115,10],[94,8,116,8],[94,9,116,9],[95,8,116,9],[95,25,116,9,"_x"],[95,27,116,9],[96,10,116,9],[96,17,116,9,"_ref"],[96,21,116,9],[96,22,116,9,"apply"],[96,27,116,9],[96,34,116,9,"arguments"],[96,43,116,9],[97,8,116,9],[98,6,116,9],[98,9,117,6],[98,10,117,7],[98,11,118,7,"subscribe"],[98,20,118,16],[98,21,118,17],[98,22,118,18],[99,6,120,4],[99,13,120,11],[99,19,120,17],[100,8,121,6,"supabase"],[100,20,121,14],[100,21,121,14,"supabase"],[100,29,121,14],[100,30,121,15,"removeChannel"],[100,43,121,28],[100,44,121,29,"channel"],[100,51,121,36],[100,52,121,37],[101,6,122,4],[101,7,122,5],[102,4,123,2],[102,5,123,3],[102,7,123,5],[102,8,123,6,"conversationId"],[102,22,123,20],[102,24,123,22,"queryClient"],[102,35,123,33],[102,37,123,35,"user"],[102,41,123,39],[102,43,123,41,"id"],[102,45,123,43],[102,47,123,45,"options"],[102,54,123,52],[102,55,123,53],[102,56,123,54],[103,2,124,0],[103,3,124,1],[104,2,126,0],[104,6,126,0,"_default"],[104,14,126,0],[104,17,126,15,"useRealtimeChat"],[104,32,126,30],[105,0,126,31],[105,3]],"functionMap":{"names":["<global>","useRealtimeChat","useEffect$argument_0","supabase.channel.on$argument_2","queryClient.setQueryData$argument_1","old.pages.flatMap$argument_0","page.map$argument_0","<anonymous>"],"mappings":"AAA;wBC4B;YCO;QCa;YCgC;+CCS;yBCC,WD,CD;aDW;SDc;WKI;KLE;GDC;CDC"},"hasCjsExports":false},"type":"js/module"}]}