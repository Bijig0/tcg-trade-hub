{"dependencies":[{"name":"@babel/runtime/helpers/toConsumableArray","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"kiCFfIx1MWoD4noR0gEoyrFAUKE=","exportNames":["*"],"imports":1}},{"name":"@babel/runtime/helpers/asyncToGenerator","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"YisBBiy2Xm9DEVdFebZ2nbgAHBo=","exportNames":["*"],"imports":1}},{"name":"react","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":34,"index":34}}],"key":"RtGiGa+/H7VrI7GDQDLhO1UbpU8=","exportNames":["*"],"imports":1}},{"name":"@tanstack/react-query","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":35},"end":{"line":2,"column":55,"index":90}}],"key":"Pzwu/0TIyhnZOrC9PAkpZx92hFo=","exportNames":["*"],"imports":1}},{"name":"@/lib/supabase","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":91},"end":{"line":3,"column":42,"index":133}}],"key":"KSAjB91cgWz7DQuLWke0G0l9TgA=","exportNames":["*"],"imports":1}},{"name":"@/context/AuthProvider","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":4,"column":0,"index":134},"end":{"line":4,"column":49,"index":183}}],"key":"hnDMt1RwOyVwgo481TGNr6ITBm4=","exportNames":["*"],"imports":1}},{"name":"../../queryKeys","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":5,"column":0,"index":184},"end":{"line":5,"column":43,"index":227}}],"key":"9dB6801Llb9DiWHOk43CNQJdoj8=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  var _s = $RefreshSig$();\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  Object.defineProperty(exports, \"default\", {\n    enumerable: true,\n    get: function () {\n      return _default;\n    }\n  });\n  var _babelRuntimeHelpersToConsumableArray = require(_dependencyMap[0], \"@babel/runtime/helpers/toConsumableArray\");\n  var _toConsumableArray = _interopDefault(_babelRuntimeHelpersToConsumableArray);\n  var _babelRuntimeHelpersAsyncToGenerator = require(_dependencyMap[1], \"@babel/runtime/helpers/asyncToGenerator\");\n  var _asyncToGenerator = _interopDefault(_babelRuntimeHelpersAsyncToGenerator);\n  var _react = require(_dependencyMap[2], \"react\");\n  var _tanstackReactQuery = require(_dependencyMap[3], \"@tanstack/react-query\");\n  var _libSupabase = require(_dependencyMap[4], \"@/lib/supabase\");\n  var _contextAuthProvider = require(_dependencyMap[5], \"@/context/AuthProvider\");\n  var _queryKeys = require(_dependencyMap[6], \"../../queryKeys\");\n  var NEGOTIATION_MESSAGE_TYPES = new Set(['card_offer', 'card_offer_response', 'meetup_proposal', 'meetup_response']);\n  /**\n   * Subscribes to Supabase Realtime for new messages in a conversation.\n   * On INSERT, adds the message to the TanStack Query cache.\n   *\n   * Also invalidates trade context when negotiation-related messages arrive,\n   * and calls an optional onNewMessage callback for read tracking.\n   */\n  var useRealtimeChat = function useRealtimeChat(conversationId, options) {\n    _s();\n    var queryClient = (0, _tanstackReactQuery.useQueryClient)();\n    var _useAuth = (0, _contextAuthProvider.useAuth)(),\n      user = _useAuth.user;\n    (0, _react.useEffect)(function () {\n      if (!conversationId) return;\n      var channel = _libSupabase.supabase.channel(`messages:${conversationId}`).on('postgres_changes', {\n        event: 'INSERT',\n        schema: 'public',\n        table: 'messages',\n        filter: `conversation_id=eq.${conversationId}`\n      }, /*#__PURE__*/function () {\n        var _ref = (0, _asyncToGenerator.default)(function* (payload) {\n          var _ref2;\n          var newMessage = payload.new;\n\n          // Don't duplicate our own optimistically-added messages\n          if (newMessage.sender_id === (user == null ? void 0 : user.id)) return;\n\n          // Notify caller (for read tracking)\n          options == null || options.onNewMessage == null || options.onNewMessage(newMessage);\n\n          // Fetch the sender info\n          var _yield$supabase$from$ = yield _libSupabase.supabase.from('users').select('id, display_name, avatar_url').eq('id', newMessage.sender_id).single(),\n            senderData = _yield$supabase$from$.data;\n          var messageWithSender = Object.assign({}, newMessage, {\n            sender: (_ref2 = senderData) != null ? _ref2 : {\n              id: newMessage.sender_id,\n              display_name: 'Unknown',\n              avatar_url: null\n            }\n          });\n          var messagesKey = _queryKeys.chatKeys.messages(conversationId);\n          queryClient.setQueryData(messagesKey, function (old) {\n            var _old$pages$;\n            if (!old) {\n              return {\n                pages: [[messageWithSender]],\n                pageParams: [null]\n              };\n            }\n\n            // Prevent duplicates\n            var allIds = old.pages.flatMap(function (page) {\n              return page.map(function (m) {\n                return m.id;\n              });\n            });\n            if (allIds.includes(messageWithSender.id)) return old;\n            return Object.assign({}, old, {\n              pages: [[messageWithSender].concat((0, _toConsumableArray.default)((_old$pages$ = old.pages[0]) != null ? _old$pages$ : []))].concat((0, _toConsumableArray.default)(old.pages.slice(1)))\n            });\n          });\n\n          // Also invalidate conversations list to update last message\n          queryClient.invalidateQueries({\n            queryKey: _queryKeys.chatKeys.conversations()\n          });\n\n          // Invalidate trade context for negotiation-related messages\n          if (NEGOTIATION_MESSAGE_TYPES.has(newMessage.type)) {\n            queryClient.invalidateQueries({\n              queryKey: _queryKeys.chatKeys.tradeContext(conversationId)\n            });\n          }\n        });\n        return function (_x) {\n          return _ref.apply(this, arguments);\n        };\n      }()).subscribe();\n      return function () {\n        _libSupabase.supabase.removeChannel(channel);\n      };\n    }, [conversationId, queryClient, user == null ? void 0 : user.id, options]);\n  };\n  _s(useRealtimeChat, \"TDrJ95GxdHquDBjgVv/lJ4LOc/A=\", false, function () {\n    return [_tanstackReactQuery.useQueryClient, _contextAuthProvider.useAuth];\n  });\n  var _default = useRealtimeChat;\n});","lineCount":116,"map":[[13,2,126,0,"Object"],[13,8,126,0],[13,9,126,0,"defineProperty"],[13,23,126,0],[13,24,126,0,"exports"],[13,31,126,0],[14,4,126,0,"enumerable"],[14,14,126,0],[15,4,126,0,"get"],[15,7,126,0],[15,18,126,0,"get"],[15,19,126,0],[16,6,126,0],[16,13,126,0,"_default"],[16,21,126,0],[17,4,126,0],[18,2,126,0],[19,2,126,31],[19,6,126,31,"_babelRuntimeHelpersToConsumableArray"],[19,43,126,31],[19,46,126,31,"require"],[19,53,126,31],[19,54,126,31,"_dependencyMap"],[19,68,126,31],[20,2,126,31],[20,6,126,31,"_toConsumableArray"],[20,24,126,31],[20,27,126,31,"_interopDefault"],[20,42,126,31],[20,43,126,31,"_babelRuntimeHelpersToConsumableArray"],[20,80,126,31],[21,2,126,31],[21,6,126,31,"_babelRuntimeHelpersAsyncToGenerator"],[21,42,126,31],[21,45,126,31,"require"],[21,52,126,31],[21,53,126,31,"_dependencyMap"],[21,67,126,31],[22,2,126,31],[22,6,126,31,"_asyncToGenerator"],[22,23,126,31],[22,26,126,31,"_interopDefault"],[22,41,126,31],[22,42,126,31,"_babelRuntimeHelpersAsyncToGenerator"],[22,78,126,31],[23,2,1,0],[23,6,1,0,"_react"],[23,12,1,0],[23,15,1,0,"require"],[23,22,1,0],[23,23,1,0,"_dependencyMap"],[23,37,1,0],[24,2,2,0],[24,6,2,0,"_tanstackReactQuery"],[24,25,2,0],[24,28,2,0,"require"],[24,35,2,0],[24,36,2,0,"_dependencyMap"],[24,50,2,0],[25,2,3,0],[25,6,3,0,"_libSupabase"],[25,18,3,0],[25,21,3,0,"require"],[25,28,3,0],[25,29,3,0,"_dependencyMap"],[25,43,3,0],[26,2,4,0],[26,6,4,0,"_contextAuthProvider"],[26,26,4,0],[26,29,4,0,"require"],[26,36,4,0],[26,37,4,0,"_dependencyMap"],[26,51,4,0],[27,2,5,0],[27,6,5,0,"_queryKeys"],[27,16,5,0],[27,19,5,0,"require"],[27,26,5,0],[27,27,5,0,"_dependencyMap"],[27,41,5,0],[28,2,10,0],[28,6,10,6,"NEGOTIATION_MESSAGE_TYPES"],[28,31,10,31],[28,34,10,34],[28,38,10,38,"Set"],[28,41,10,41],[28,42,10,42],[28,43,11,2],[28,55,11,14],[28,57,12,2],[28,78,12,23],[28,80,13,2],[28,97,13,19],[28,99,14,2],[28,116,14,19],[28,117,15,1],[28,118,15,2],[29,2,22,0],[30,0,23,0],[31,0,24,0],[32,0,25,0],[33,0,26,0],[34,0,27,0],[35,0,28,0],[36,2,29,0],[36,6,29,6,"useRealtimeChat"],[36,21,29,21],[36,24,29,24],[36,33,29,6,"useRealtimeChat"],[36,48,29,21,"useRealtimeChat"],[36,49,30,2,"conversationId"],[36,63,30,24],[36,65,31,2,"options"],[36,72,31,34],[36,74,32,5],[37,4,32,5,"_s"],[37,6,32,5],[38,4,33,2],[38,8,33,8,"queryClient"],[38,19,33,19],[38,22,33,22],[38,26,33,22,"useQueryClient"],[38,45,33,36],[38,46,33,36,"useQueryClient"],[38,60,33,36],[38,62,33,37],[38,63,33,38],[39,4,34,2],[39,8,34,2,"_useAuth"],[39,16,34,2],[39,19,34,19],[39,23,34,19,"useAuth"],[39,43,34,26],[39,44,34,26,"useAuth"],[39,51,34,26],[39,53,34,27],[39,54,34,28],[40,6,34,10,"user"],[40,10,34,14],[40,13,34,14,"_useAuth"],[40,21,34,14],[40,22,34,10,"user"],[40,26,34,14],[41,4,36,2],[41,8,36,2,"useEffect"],[41,14,36,11],[41,15,36,11,"useEffect"],[41,24,36,11],[41,26,36,12],[41,38,36,18],[42,6,37,4],[42,10,37,8],[42,11,37,9,"conversationId"],[42,25,37,23],[42,27,37,25],[43,6,39,4],[43,10,39,10,"channel"],[43,17,39,17],[43,20,39,20,"supabase"],[43,32,39,28],[43,33,39,28,"supabase"],[43,41,39,28],[43,42,40,7,"channel"],[43,49,40,14],[43,50,40,15],[43,62,40,27,"conversationId"],[43,76,40,41],[43,78,40,43],[43,79,40,44],[43,80,41,7,"on"],[43,82,41,9],[43,83,42,8],[43,101,42,26],[43,103,43,8],[44,8,44,10,"event"],[44,13,44,15],[44,15,44,17],[44,23,44,25],[45,8,45,10,"schema"],[45,14,45,16],[45,16,45,18],[45,24,45,26],[46,8,46,10,"table"],[46,13,46,15],[46,15,46,17],[46,25,46,27],[47,8,47,10,"filter"],[47,14,47,16],[47,16,47,18],[47,38,47,40,"conversationId"],[47,52,47,54],[48,6,48,8],[48,7,48,9],[49,8,48,9],[49,12,48,9,"_ref"],[49,16,48,9],[49,23,48,9,"_asyncToGenerator"],[49,40,48,9],[49,41,48,9,"default"],[49,48,48,9],[49,50,49,8],[49,61,49,15,"payload"],[49,68,49,22],[49,70,49,27],[50,10,49,27],[50,14,49,27,"_ref2"],[50,19,49,27],[51,10,50,10],[51,14,50,16,"newMessage"],[51,24,50,26],[51,27,50,29,"payload"],[51,34,50,36],[51,35,50,37,"new"],[51,38,50,40],[53,10,52,10],[54,10,53,10],[54,14,53,14,"newMessage"],[54,24,53,24],[54,25,53,25,"sender_id"],[54,34,53,34],[54,40,53,39,"user"],[54,44,53,43],[54,64,53,39,"user"],[54,68,53,43],[54,69,53,45,"id"],[54,71,53,47],[54,74,53,49],[56,10,55,10],[57,10,56,10,"options"],[57,17,56,17],[57,29,56,10,"options"],[57,36,56,17],[57,37,56,19,"onNewMessage"],[57,49,56,31],[57,61,56,10,"options"],[57,68,56,17],[57,69,56,19,"onNewMessage"],[57,81,56,31],[57,82,56,34,"newMessage"],[57,92,56,44],[57,93,56,45],[59,10,58,10],[60,10,59,10],[60,14,59,10,"_yield$supabase$from$"],[60,35,59,10],[60,44,59,45,"supabase"],[60,56,59,53],[60,57,59,53,"supabase"],[60,65,59,53],[60,66,60,13,"from"],[60,70,60,17],[60,71,60,18],[60,78,60,25],[60,79,60,26],[60,80,61,13,"select"],[60,86,61,19],[60,87,61,20],[60,117,61,50],[60,118,61,51],[60,119,62,13,"eq"],[60,121,62,15],[60,122,62,16],[60,126,62,20],[60,128,62,22,"newMessage"],[60,138,62,32],[60,139,62,33,"sender_id"],[60,148,62,42],[60,149,62,43],[60,150,63,13,"single"],[60,156,63,19],[60,157,63,20],[60,158,63,21],[61,12,59,24,"senderData"],[61,22,59,34],[61,25,59,34,"_yield$supabase$from$"],[61,46,59,34],[61,47,59,18,"data"],[61,51,59,22],[62,10,65,10],[62,14,65,16,"messageWithSender"],[62,31,65,52],[62,34,65,52,"Object"],[62,40,65,52],[62,41,65,52,"assign"],[62,47,65,52],[62,52,66,15,"newMessage"],[62,62,66,25],[63,12,67,12,"sender"],[63,18,67,18],[63,21,67,18,"_ref2"],[63,26,67,18],[63,29,67,21,"senderData"],[63,39,67,31],[63,51,67,31,"_ref2"],[63,56,67,31],[63,59,70,18],[64,14,71,14,"id"],[64,16,71,16],[64,18,71,18,"newMessage"],[64,28,71,28],[64,29,71,29,"sender_id"],[64,38,71,38],[65,14,72,14,"display_name"],[65,26,72,26],[65,28,72,28],[65,37,72,37],[66,14,73,14,"avatar_url"],[66,24,73,24],[66,26,73,26],[67,12,74,12],[68,10,74,13],[68,12,75,11],[69,10,77,10],[69,14,77,16,"messagesKey"],[69,25,77,27],[69,28,77,30,"chatKeys"],[69,38,77,38],[69,39,77,38,"chatKeys"],[69,47,77,38],[69,48,77,39,"messages"],[69,56,77,47],[69,57,77,48,"conversationId"],[69,71,77,62],[69,72,77,63],[70,10,79,10,"queryClient"],[70,21,79,21],[70,22,79,22,"setQueryData"],[70,34,79,34],[70,35,80,12,"messagesKey"],[70,46,80,23],[70,48,81,12],[70,58,81,13,"old"],[70,61,81,16],[70,63,81,21],[71,12,81,21],[71,16,81,21,"_old$pages$"],[71,27,81,21],[72,12,82,14],[72,16,82,18],[72,17,82,19,"old"],[72,20,82,22],[72,22,82,24],[73,14,83,16],[73,21,83,23],[74,16,84,18,"pages"],[74,21,84,23],[74,23,84,25],[74,24,84,26],[74,25,84,27,"messageWithSender"],[74,42,84,44],[74,43,84,45],[74,44,84,46],[75,16,85,18,"pageParams"],[75,26,85,28],[75,28,85,30],[75,29,85,31],[75,33,85,35],[76,14,86,16],[76,15,86,17],[77,12,87,14],[79,12,89,14],[80,12,90,14],[80,16,90,20,"allIds"],[80,22,90,26],[80,25,90,29,"old"],[80,28,90,32],[80,29,90,33,"pages"],[80,34,90,38],[80,35,90,39,"flatMap"],[80,42,90,46],[80,43,90,47],[80,53,90,48,"page"],[80,57,90,52],[81,14,90,52],[81,21,91,16,"page"],[81,25,91,20],[81,26,91,21,"map"],[81,29,91,24],[81,30,91,25],[81,40,91,26,"m"],[81,41,91,27],[82,16,91,27],[82,23,91,32,"m"],[82,24,91,33],[82,25,91,34,"id"],[82,27,91,36],[83,14,91,36],[83,16,91,37],[84,12,91,37],[84,13,92,14],[84,14,92,15],[85,12,93,14],[85,16,93,18,"allIds"],[85,22,93,24],[85,23,93,25,"includes"],[85,31,93,33],[85,32,93,34,"messageWithSender"],[85,49,93,51],[85,50,93,52,"id"],[85,52,93,54],[85,53,93,55],[85,55,93,57],[85,62,93,64,"old"],[85,65,93,67],[86,12,95,14],[86,19,95,14,"Object"],[86,25,95,14],[86,26,95,14,"assign"],[86,32,95,14],[86,37,96,19,"old"],[86,40,96,22],[87,14,97,16,"pages"],[87,19,97,21],[87,23,98,19,"messageWithSender"],[87,40,98,36],[87,42,98,36,"concat"],[87,48,98,36],[87,53,98,36,"_toConsumableArray"],[87,71,98,36],[87,72,98,36,"default"],[87,79,98,36],[87,82,98,36,"_old$pages$"],[87,93,98,36],[87,96,98,42,"old"],[87,99,98,45],[87,100,98,46,"pages"],[87,105,98,51],[87,106,98,52],[87,107,98,53],[87,108,98,54],[87,120,98,54,"_old$pages$"],[87,131,98,54],[87,134,98,58],[87,136,98,60],[87,140,98,60,"concat"],[87,146,98,60],[87,151,98,60,"_toConsumableArray"],[87,169,98,60],[87,170,98,60,"default"],[87,177,98,60],[87,179,99,21,"old"],[87,182,99,24],[87,183,99,25,"pages"],[87,188,99,30],[87,189,99,31,"slice"],[87,194,99,36],[87,195,99,37],[87,196,99,38],[87,197,99,39],[88,12,100,17],[89,10,102,12],[89,11,103,10],[89,12,103,11],[91,10,105,10],[92,10,106,10,"queryClient"],[92,21,106,21],[92,22,106,22,"invalidateQueries"],[92,39,106,39],[92,40,106,40],[93,12,107,12,"queryKey"],[93,20,107,20],[93,22,107,22,"chatKeys"],[93,32,107,30],[93,33,107,30,"chatKeys"],[93,41,107,30],[93,42,107,31,"conversations"],[93,55,107,44],[93,56,107,45],[94,10,108,10],[94,11,108,11],[94,12,108,12],[96,10,110,10],[97,10,111,10],[97,14,111,14,"NEGOTIATION_MESSAGE_TYPES"],[97,39,111,39],[97,40,111,40,"has"],[97,43,111,43],[97,44,111,44,"newMessage"],[97,54,111,54],[97,55,111,55,"type"],[97,59,111,59],[97,60,111,60],[97,62,111,62],[98,12,112,12,"queryClient"],[98,23,112,23],[98,24,112,24,"invalidateQueries"],[98,41,112,41],[98,42,112,42],[99,14,113,14,"queryKey"],[99,22,113,22],[99,24,113,24,"chatKeys"],[99,34,113,32],[99,35,113,32,"chatKeys"],[99,43,113,32],[99,44,113,33,"tradeContext"],[99,56,113,45],[99,57,113,46,"conversationId"],[99,71,113,60],[100,12,114,12],[100,13,114,13],[100,14,114,14],[101,10,115,10],[102,8,116,8],[102,9,116,9],[103,8,116,9],[103,25,116,9,"_x"],[103,27,116,9],[104,10,116,9],[104,17,116,9,"_ref"],[104,21,116,9],[104,22,116,9,"apply"],[104,27,116,9],[104,34,116,9,"arguments"],[104,43,116,9],[105,8,116,9],[106,6,116,9],[106,9,117,6],[106,10,117,7],[106,11,118,7,"subscribe"],[106,20,118,16],[106,21,118,17],[106,22,118,18],[107,6,120,4],[107,13,120,11],[107,25,120,17],[108,8,121,6,"supabase"],[108,20,121,14],[108,21,121,14,"supabase"],[108,29,121,14],[108,30,121,15,"removeChannel"],[108,43,121,28],[108,44,121,29,"channel"],[108,51,121,36],[108,52,121,37],[109,6,122,4],[109,7,122,5],[110,4,123,2],[110,5,123,3],[110,7,123,5],[110,8,123,6,"conversationId"],[110,22,123,20],[110,24,123,22,"queryClient"],[110,35,123,33],[110,37,123,35,"user"],[110,41,123,39],[110,61,123,35,"user"],[110,65,123,39],[110,66,123,41,"id"],[110,68,123,43],[110,70,123,45,"options"],[110,77,123,52],[110,78,123,53],[110,79,123,54],[111,2,124,0],[111,3,124,1],[112,2,124,2,"_s"],[112,4,124,2],[112,5,29,6,"useRealtimeChat"],[112,20,29,21],[113,4,29,21],[113,12,33,22,"useQueryClient"],[113,31,33,36],[113,32,33,36,"useQueryClient"],[113,46,33,36],[113,48,34,19,"useAuth"],[113,68,34,26],[113,69,34,26,"useAuth"],[113,76,34,26],[114,2,34,26],[115,2,126,0],[115,6,126,0,"_default"],[115,14,126,0],[115,17,126,15,"useRealtimeChat"],[115,32,126,30],[116,0,126,31],[116,3]],"functionMap":{"names":["<global>","useRealtimeChat","useEffect$argument_0","supabase.channel.on$argument_2","queryClient.setQueryData$argument_1","old.pages.flatMap$argument_0","page.map$argument_0","<anonymous>"],"mappings":"AAA;wBC4B;YCO;QCa;YCgC;+CCS;yBCC,WD,CD;aDW;SDc;WKI;KLE;GDC;CDC"},"hasCjsExports":false},"type":"js/module"}]}